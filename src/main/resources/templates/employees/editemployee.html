<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>プロジェクトチーム編成システム</title>
    <meta charset="UTF-8">
</head>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9AYeyskwcrm1_A8f_o0maHvMsBIiZ6BI&libraries=places"></script>
<script th:inline="javascript">
    let map;
    let marker;
    let autocomplete;
    const skills = /*[[${skills}]]*/ [];

    function initMap() {
        const initialLocation = {lat: /*[[${employeesRequest.latitude}]]*/, lng: /*[[${employeesRequest.longitude}]]*/};

        map = new google.maps.Map(document.getElementById('map'), {
            center: initialLocation,
            zoom: 12
        });

        marker = new google.maps.Marker({
            map: map,
            position: initialLocation,
            draggable: true
        });

        const input = document.getElementById('address');
        autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo('bounds', map);

        autocomplete.addListener('place_changed', function () {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
                alert("No details available for input: '" + place.name + "'");
                return;
            }

            map.setCenter(place.geometry.location);
            map.setZoom(15);

            marker.setPosition(place.geometry.location);

            document.getElementById('latitude').value = place.geometry.location.lat();
            document.getElementById('longitude').value = place.geometry.location.lng();
        });
    }

    function addSkillCareer() {
        if (validateDuplicateSkills()) {
            return; // 중복이 있으면 새로운 항목을 추가하지 않습니다.
        }

        const skillCareerContainer = document.getElementById('skillCareerContainer');
        const index = skillCareerContainer.querySelectorAll('.skillCareer-item').length;

        const skillCareerItem = document.createElement('div');
        skillCareerItem.classList.add('skillCareer-item');

        let skillOptions = '';
        skills.forEach(skill => {
            skillOptions += `<option value="${skill.skillId}">${skill.skillName}</option>`;
        });

        skillCareerItem.innerHTML = `
            <div class="form-group">
                <label for="employeesSkillRequests[${index}].skill.skillId">プログラミング言語</label>
                <select id="employeesSkillRequests[${index}].skill.skillId" name="employeesSkillRequests[${index}].skill.skillId" required>
                    ${skillOptions}
                </select>
            </div>
            <div class="form-group">
                <label for="employeesSkillRequests[${index}].skillCareer">経歴年数</label>
                <input type="number" id="employeesSkillRequests[${index}].skillCareer" name="employeesSkillRequests[${index}].skillCareer" required
                min="1" oninput="this.value = Math.max(this.value, 1)">
                ヶ月
            </div>
            <button type="button" id="delete-btn"  onclick="removeSkillCareer(this)">追加取り消し</button>
        `;
        skillCareerContainer.appendChild(skillCareerItem);
        skillCareerItem.querySelector('select').addEventListener('change', validateDuplicateSkills);

    }

    function removeSkillCareer(button) {
        const skillCareerItem = button.parentElement;
        skillCareerItem.remove();


        // 기존 항목에 대해 인덱스를 다시 할당
        const skillCareerContainer = document.getElementById('skillCareerContainer');
        const items = skillCareerContainer.querySelectorAll('.skillCareer-item');
        items.forEach((item, index) => {
            const skillSelect = item.querySelector('select');
            const careerInput = item.querySelector('input[type="number"]');

            skillSelect.setAttribute('name', `employeesSkillRequests[${index}].skill.skillId`);
            skillSelect.setAttribute('id', `employeesSkillRequests[${index}].skill.skillId`);

            careerInput.setAttribute('name', `employeesSkillRequests[${index}].skillCareer`);
            careerInput.setAttribute('id', `employeesSkillRequests[${index}].skillCareer`);
        });
        // 기존 항목에 대해 인덱스를 다시 할당
    }

    //8월 20일 10:06 시도중
    function validateDuplicateSkills() {
        const skillSelects = document.querySelectorAll('select[name^="employeesSkillRequests"]');
        const selectedSkills = new Set();
        let hasDuplicates = false;

        skillSelects.forEach(select => {
            console.log('Selected value:', select.value); // 선택된 값 확인
            if (selectedSkills.has(select.value)) {
                hasDuplicates = true;
            }
            selectedSkills.add(select.value);
        });

        if (hasDuplicates) {
            alert('同じプログラミング言語のキャリアを重複して入力できません');
        }

        return hasDuplicates;
    }

    document.getElementById('addSkillCareer-btn').addEventListener('click', function (event) {
        if (validateDuplicateSkills()) {
            event.preventDefault(); // 중복이 있을 때 추가 버튼이 동작하지 않도록 합니다.
        } else {
            addSkillCareer();
        }
    });

    function handleSubmit(event) {
        const hasDuplicates = validateDuplicateSkills(); // 중복 체크
        if (hasDuplicates) {
            event.preventDefault(); // 중복이 있을 때 폼 제출을 막습니다.
            console.log('Form submission prevented due to duplicate skills.'); // 폼 제출이 막혔을 때 로그 출력
            // alert('同じプログラミング言語のキャリアを重複して入力できません');
        }
    }
    //8월 20일 10:06 시도중



    function redirectToEmployeesList() {
        window.location.href = "/employees";
    }

    window.onload = function () {
        initMap();
    };
</script>
<style>
    body {
        overflow-y: hidden; /* Y축 스크롤 비활성화 */
        overflow-x: auto; /* X축 스크롤 활성화 */
        padding: 0;
        margin: 0;
    }

    .container {
        height: auto;
        width: 95vw;
    }

    #map {
        height: 350px;
        width: 350px;
    }


    .menu {
        background-color: #1e90ff;
        width: 250px;
        height: 100vh;
    }

    .menus > li {
        width: 200px;
        height: 40px;
        justify-content: center;
        align-items: center;
        padding: 15px 20px;
        cursor: pointer;
        transition: background 0.3s ease;
        text-align: center;
        font-size: 18px;
    }

    .menus li a {
        display: block;
        width: 100%;
        height: 100%;
        text-align: center; /* 텍스트 가운데 정렬 */
        padding: 15px 20px; /* a 요소에 패딩을 적용 */
        box-sizing: border-box;
        text-decoration: none; /* 밑줄 제거 */
        color: inherit; /* 부모 요소의 색상을 상속 */
    }

    .menus {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .menus li:hover {
        background: linear-gradient(45deg, #1e90ff, #00bfff);
        color: #fff;
        border-top-right-radius: 40px;
        border-bottom-right-radius: 40px;
    }


    .contents {
        background-color: #f5f5f5;
        width: 1170px;
        height: auto;
        border-radius: 15px 15px 0 0;
        overflow-y: auto;
        scrollbar-width: none;

        display: flex;
        flex-direction: column; /* 수직 방향으로 요소 배치 */
    }

    .contents::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }

    .contents p {
        height: 35px;
        margin-left: 30px;
    }


    form {
        max-width: 50%;
        max-height: 55%;
        background: rgba(173, 216, 230, 0.2);
        margin: 0 auto;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        scrollbar-width: none;
    }

    .form-group {
        margin-top: 10px;
        margin-bottom: 10px;
        text-align: left;
    }


    label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
    }

    input[type="text"], input[type="date"], select, input[type="file"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 16px;
    }

    #addSkillCareer-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #87cefa;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
    }

    #submit-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #71b6ff;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
    }

    #delete-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #ef4747;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
    }

    #back-to-employeeslist {
        font-family: "Noto Sans JP", sans-serif; /* 일본어 텍스트에 어울리는 글꼴을 사용합니다. */
        font-size: 14px; /* 글자 크기를 14px로 설정합니다. */
        color: #fff; /* 텍스트 색상을 흰색으로 설정합니다. */
        background: linear-gradient(45deg, #4a90e2, #87cefa); /* 버튼 배경색을 그라데이션으로 설정합니다. */
        border: none; /* 기본 테두리를 제거합니다. */
        border-radius: 20px; /* 버튼에 둥근 테두리를 적용합니다. */
        padding: 7px 14px; /* 내부 여백을 설정합니다. */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 상자 그림자 효과를 추가합니다. */
        cursor: pointer; /* 마우스 포인터를 손가락 모양으로 변경합니다. */
        transition: background 0.3s ease, transform 0.3s ease; /* 배경색과 크기 변화에 부드러운 전환 효과를 적용합니다. */
    }

    .button-container {
        display: flex;
        justify-content: flex-end; /* 버튼을 오른쪽 끝으로 이동 */
        margin-bottom: 10px; /* 버튼과 폼 사이의 간격 */
    }

    button {
        display: inline-block;
        text-align: center;
        margin: 0 auto; /* 버튼을 가운데 정렬 */
    }

    button[type="submit"], button[type="button"] {
        display: block;
        margin: 0 auto; /* submit 및 추가 버튼을 가운데 정렬 */
    }

    #back-to-employeeslist {
        margin: 0; /* 오버라이드: 오른쪽으로 붙는 버튼은 margin 제거 */
    }


</style>
<body onload="initMap()">
<div class="container" style="display: flex">
    <div class="menu">
        <ul class="menus">
            <li><a href="/index">MainPage</a></li>
            <li><a href="/employees">社員リスト</a></li>
            <li><a href="/readAllProjects">Projects</a></li>
        </ul>
    </div>

    <div class="contents">
        <p style="text-align: center; font-size: 26px">社員修整 </p>
        <div class="button-container">
            <button type="button" id="back-to-employeeslist" th:onclick="|redirectToEmployeesList()|">社員リスト
            </button>
        </div>
        <form th:action="@{/employees/update}" th:object="${employeesRequest}" method="post"
              enctype="multipart/form-data">
            <input type="hidden" th:field="*{employeeId}"/>

            <div class="form-group">
                <label for="name">社員名</label>
                <input type="text" id="name" th:field="*{name}" placeholder="Enter name" required/><br/>
            </div>

            <div class="form-group">
                <label for="address">住所</label>
                <input type="text" id="address" th:field="*{address}" placeholder="Enter address" required/><br/>
            </div>

            <div class="form-group">
                <label for="hireDate">入社日</label>
                <input type="date" id="hireDate" th:field="*{hireDate}" required/><br/>
            </div>

            <div class="form-group">
                <label for="contactNumber">電話番号</label>
                <input type="text" id="contactNumber" th:field="*{contactNumber}"
                       placeholder="Enter contact number"/><br/>
            </div>

            <div class="form-group">
                <label for="imageFile">新たなプロフィール写真登録</label>
                <input type="file" id="imageFile" name="imageFile">
                <input type="hidden" id="existingImage" name="existingImage" th:value="*{image}"/>
                <div th:if="*{image}">
                    <p>既登録プロフィール写真</p>
                    <img th:src="@{${employeesRequest.image}}" alt="Employee Image"
                         style="max-width: 150px; border-radius: 4px; margin-top: 10px;">
                </div>
            </div>

            <div class="form-group">
                <label for="preferredLanguage">興味ある言語</label>
                <select id="preferredLanguage" th:field="*{preferredLanguage}" required>
                    <option th:each="skill : ${skills}" th:value="${skill.skillId}" th:text="${skill.skillName}"
                            th:selected="${skill.skillId} == ${employeesRequest.preferredLanguage}">Select Language
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="preferredProjectType">興味ある案件種類</label>
                <select id="preferredProjectType" th:field="*{preferredProjectType}" required>
                    <option th:each="type : ${projectTypes}" th:value="${type.projectTypeId}"
                            th:text="${type.projectTypeName}"
                            th:selected="${type.projectTypeId} == ${employeesRequest.preferredProjectType}">Select
                        Project Type
                    </option>
                </select>
            </div>

            <div id="skillCareerContainer">
                <div th:each="employeesSkillRequest, iter : ${employeesRequest.employeesSkillRequests}"
                     class="form-group skillCareer-item">
                    <label>기존등록언어</label>
                    <select th:field="*{employeesSkillRequests[__${iter.index}__].skill.skillId}">
                        <option th:each="skill : ${skills}" th:value="${skill.skillId}" th:text="${skill.skillName}"
                                th:selected="${skill.skillId} == ${employeesSkillRequest.skill.skillId}"></option>
                    </select>

                    <label>기존등록경력(Months):</label>
                    <input type="number" th:field="*{employeesSkillRequests[__${iter.index}__].skillCareer}"/>
                    <button type="button" id="delete-btn" onclick="removeSkillCareer(this)">追加取り消し</button>
                </div>
            </div>

            <div class="form-group">
                <button type="button" id="addSkillCareer-btn" onclick="addSkillCareer()">プログラミング経歴追加</button>
            </div>

            <br/>

            <button type="submit" id="submit-btn" onclick="handleSubmit(event)">社員情報更新</button>

            <input type="text" id="latitude" style="display: none;" th:field="*{latitude}"/><br/>
            <input type="text" id="longitude" style="display: none;" th:field="*{longitude}"/><br/>
            <div id="map" style="display: none;"></div>


        </form>
    </div>
</div>
</body>
</html>
