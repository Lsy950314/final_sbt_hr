<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>プロジェクトチーム編成システム</title>
    <meta charset="UTF-8">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr 일본어 설정 -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
</head>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9AYeyskwcrm1_A8f_o0maHvMsBIiZ6BI&libraries=places&language=ja"></script>
<script th:inline="javascript">
    let map;
    let marker;
    let autocomplete;
    // let skillCount = 0;

    const skills = /*[[${skills}]]*/[];

    function initMap() {
        const initialLocation = {lat: 35.6895, lng: 139.6917};

        map = new google.maps.Map(document.getElementById('map'), {
            center: initialLocation,
            zoom: 12
        });

        marker = new google.maps.Marker({
            map: map,
            position: initialLocation,
            draggable: true
        });

        const input = document.getElementById('address');
        autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo('bounds', map);

        autocomplete.addListener('place_changed', function () {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
                alert("No details available for input: '" + place.name + "'");
                return;
            }

            map.setCenter(place.geometry.location);
            map.setZoom(15);

            marker.setPosition(place.geometry.location);

            document.getElementById('latitude').value = place.geometry.location.lat();
            document.getElementById('longitude').value = place.geometry.location.lng();
        });
    }


    function removeSkills(button) {
        const skillCareerItem = button.parentElement;
        skillCareerItem.remove();
    }


    function redirectToEmployeesList() {
        window.location.href = "/employees";
    }

    function updateFileName(event) {
        const input = event.target;
        const label = document.getElementById("fileLabel");

        if (input.files && input.files.length > 0) {
            label.textContent = input.files[0].name;
        } else {
            label.textContent = "ファイルを選択";
        }

        // 이미지 미리보기 업데이트
        previewImage(event);
    }

    function previewImage(event) {
        const reader = new FileReader();
        reader.onload = function () {
            const output = document.getElementById('imagePreview');
            output.src = reader.result;
            output.style.display = 'block';  // 이미지를 표시합니다.
        };
        reader.readAsDataURL(event.target.files[0]);
    }

    window.onload = function () {
        initMap();
    };


    function addSkillCareer() {
        if (validateDuplicateSkills()) {
            return; // 중복이 있으면 새로운 항목을 추가하지 않습니다.
        }

        const skillCareerContainer = document.getElementById('skillCareerContainer');
        const index = skillCareerContainer.children.length;

        const skillCareerItem = document.createElement('div');
        skillCareerItem.classList.add('skillCareer-item');

        let skillOptions = '';
        skills.forEach(skill => {
            skillOptions += `<option value="${skill.skillId}">${skill.skillName}</option>`;
        });

        skillCareerItem.innerHTML = `
            <div class="form-group">
                <label for="employeesskill[${index}].skill.skillId">プログラミング言語</label>
                <select id="employeesskill[${index}].skill.skillId" name="employeesSkillRequests[${index}].skill.skillId" required>
                    ${skillOptions}
                </select>
            </div>
            <div class="form-group">
                <label for="employeesSkillRequests[${index}].skillCareer">経歴年数</label>
                <input type="number" style="font-size: 14pt" id="employeesSkillRequests[${index}].skillCareer" name="employeesSkillRequests[${index}].skillCareer" required
                 min="1" oninput="this.value = Math.max(this.value, 1)">
                ヶ月
            </div>
            <button type="button" id="delete-btn" onclick="removeSkills(this)">追加取り消し</button>
        `;
        skillCareerContainer.appendChild(skillCareerItem);
        skillCareerItem.querySelector('select').addEventListener('change', validateDuplicateSkills);

    }

    function validateDuplicateSkills() {
        const skillSelects = document.querySelectorAll('select[name^="employeesSkillRequests"]');
        const selectedSkills = new Set();
        let hasDuplicates = false;

        skillSelects.forEach(select => {
            if (selectedSkills.has(select.value)) {
                hasDuplicates = true;
            }
            selectedSkills.add(select.value);
        });

        if (hasDuplicates) {
            alert('同じプログラミング言語のキャリアを重複して入力できません');
        }

        return hasDuplicates;
    }

    document.getElementById('addSkillCareer-btn').addEventListener('click', function (event) {
        if (validateDuplicateSkills()) {
            event.preventDefault(); // 중복이 있을 때 추가 버튼이 동작하지 않도록 합니다.
        } else {
            addSkillCareer();
        }
    });

    function handleSubmit(event) {
        const hasDuplicates = validateDuplicateSkills(); // 중복 체크
        if (hasDuplicates) {
            event.preventDefault(); // 중복이 있을 때 폼 제출을 막습니다.
            console.log('Form submission prevented due to duplicate skills.'); // 폼 제출이 막혔을 때 로그 출력
            // alert('同じプログラミング言語のキャリアを重複して入力できません');
        }
    }

</script>
<style>
    body {
        overflow-y: hidden; /* Y축 스크롤 비활성화 */
        overflow-x: auto; /* X축 스크롤 활성화 */
        padding: 0;
        margin: 0;
    }

    .container {
        height: auto;
        width: 95vw;
    }

    #map {
        height: 350px;
        width: 350px;
    }

    .menu {
        background-color: #1e90ff;
        width: 250px;
        height: 100vh;
    }

    .menus > li {
        width: 101%;
        height: 40px;
        justify-content: center;
        align-items: center;
        padding: 15px 20px;
        cursor: pointer;
        transition: background 0.3s ease;
        text-align: center;
        font-size: 18px;
    }

    .menus li a {
        display: block;
        width: 100%;
        height: 100%;
        text-align: center; /* 텍스트 가운데 정렬 */
        padding: 15px 20px; /* a 요소에 패딩을 적용 */
        box-sizing: border-box;
        text-decoration: none; /* 밑줄 제거 */
        color: inherit; /* 부모 요소의 색상을 상속 */
    }

    .menus {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0;
        margin: 0;
    }

    .menu-icon {
        width: 20%; /* 이미지의 너비 설정 */
        height: auto; /* 이미지의 높이 설정 */
        vertical-align: middle; /* 이미지와 텍스트를 수직으로 가운데 정렬 */
    }

    .menus li:hover {
        background: linear-gradient(45deg, #1e90ff, #00bfff);
        color: #fff;
        border-top-right-radius: 40px;
        border-bottom-right-radius: 40px;
    }

    .contents {
        background-color: #f5f5f5;
        width: 1170px;
        height: auto;
        border-radius: 15px 15px 0 0;
        overflow-y: auto;
        scrollbar-width: none;

        display: flex;
        flex-direction: column; /* 수직 방향으로 요소 배치 */
    }

    .contents::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }

    .contents p {
        height: 35px;
        margin-left: 30px;
    }

    form {
        max-width: 50%;
        max-height: 750px; /* 폼의 최대 높이를 설정합니다 */
        background: rgba(173, 216, 230, 0.2);
        margin: 0 auto;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto; /* 폼 내부에서 수직 스크롤을 활성화합니다 */
        scrollbar-width: none; /* Firefox에서 스크롤바를 숨깁니다 */
    }

    form::-webkit-scrollbar {
        width: 0px; /* Chrome, Safari, Opera에서 스크롤바를 숨깁니다 */
        background: transparent; /* 스크롤바 트랙을 투명하게 만듭니다 */
    }

    form::-webkit-scrollbar-thumb {
        background-color: transparent; /* 스크롤바 핸들을 투명하게 만듭니다 */
    }

    .form-group {
        margin-top: 10px;
        margin-bottom: 10px;
        text-align: left;
    }

    label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
    }

    input[type="text"], input[type="date"], select, input[type="file"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 16px;
    }

    #addSkillCareer-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #87cefa;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
    }

    #submit-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #71b6ff;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
    }

    #delete-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #ef4747;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
    }

    #back-to-employeeslist {
        font-family: "Noto Sans JP", sans-serif; /* 일본어 텍스트에 어울리는 글꼴을 사용합니다. */
        font-size: 14px; /* 글자 크기를 14px로 설정합니다. */
        color: #fff; /* 텍스트 색상을 흰색으로 설정합니다. */
        background: linear-gradient(45deg, #4a90e2, #87cefa); /* 버튼 배경색을 그라데이션으로 설정합니다. */
        border: none; /* 기본 테두리를 제거합니다. */
        border-radius: 20px; /* 버튼에 둥근 테두리를 적용합니다. */
        padding: 7px 14px; /* 내부 여백을 설정합니다. */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 상자 그림자 효과를 추가합니다. */
        cursor: pointer; /* 마우스 포인터를 손가락 모양으로 변경합니다. */
        transition: background 0.3s ease, transform 0.3s ease; /* 배경색과 크기 변화에 부드러운 전환 효과를 적용합니다. */
    }

    .button-container {
        display: flex;
        justify-content: flex-end; /* 버튼을 오른쪽 끝으로 이동 */
        margin-bottom: 10px; /* 버튼과 폼 사이의 간격 */
    }

    button {
        display: inline-block;
        text-align: center;
        margin: 0 auto; /* 버튼을 가운데 정렬 */
    }

    button[type="submit"], button[type="button"] {
        display: block;
        margin: 0 auto; /* submit 및 추가 버튼을 가운데 정렬 */
    }

    #back-to-employeeslist {
        margin: 0; /* 오버라이드: 오른쪽으로 붙는 버튼은 margin 제거 */
    }

    .custom-file-upload {
        width: 93%;
        position: relative;
        display: inline-block;
        background-color: white;
        padding: 6px 12px;
        cursor: pointer;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
        font-size: 14px;
    }

    .custom-file-upload input[type="file"] {
        display: none;
    }

    #fileLabel {
        cursor: pointer;
    }


</style>
</head>
<body>
<div class="container" style="display: flex">
    <div class="menu">
        <ul class="menus">
            <li>
                <a href="/index">
                    <img src="/img/dashBoard/mainPage.png" alt="" class="menu-icon">
                    メイン·ページ
                </a>
            </li>
            <li>
                <a href="/employees">
                    <img src="/img/dashBoard/employee-list.png" alt="" class="menu-icon">
                    社員リスト
                </a>
            </li>
            <li>
                <a href="/readAllProjects">
                    <img src="/img/dashBoard/project-list.png" alt="" class="menu-icon">
                    プロジェクトリスト
                </a>
            </li>
        </ul>
    </div>
    <div class="contents">
        <p style="text-align: center; font-size: 26px">社員追加 </p>
        <div class="button-container">
            <button type="button" id="back-to-employeeslist" th:onclick="|redirectToEmployeesList()|">社員リスト
            </button>
        </div>
        <form th:action="@{/employees/createemployee}" th:object="${employeesRequest}" method="post"
              enctype="multipart/form-data">
            <div class="form-group">
                <label for="name">社員名</label>
                <input type="text" id="name" th:field="*{name}" placeholder="名前を入力" required/><br/>
            </div>

            <div class="form-group">
                <label for="address">アドレス</label>
                <input type="text" id="address" th:field="*{address}" placeholder="アドレスを入力" required/><br/>
            </div>

            <div class="form-group">
                <label for="hireDate">入社日</label>
                <input type="date" id="hireDate" th:field="*{hireDate}" required/><br/>
            </div>

            <div class="form-group">
                <label for="contactNumber">電話番号</label>
                <input type="text" id="contactNumber" th:field="*{contactNumber}"
                       placeholder="連絡先番号を入力" maxlength="13" required/><br/>
            </div>

            <div class="form-group">
                <label for="imageFile">プロフィール写真登録</label>
                <div class="custom-file-upload">
                    <label for="imageFile" id="fileLabel">ファイルを選択</label>
                    <input type="file" id="imageFile" name="imageFile" style="display: none;" onchange="updateFileName(event)">
                </div>
                <br/>
                <div style="text-align: center;">
                    <img id="imagePreview" style="display:none; max-width: 200px; border-radius: 4px; margin: 5px auto; display: block;">
                </div>
            </div>

            <div class="form-group">
                <label for="preferredLanguage">興味ある言語</label>
                <select id="preferredLanguage" th:field="*{preferredLanguage}" required>
                    <option th:each="skill : ${skills}" th:value="${skill.skillId}" th:text="${skill.skillName}">Select
                        Language
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="preferredProjectType">興味ある案件種類</label>
                <select id="preferredProjectType" th:field="*{preferredProjectType}" required>
                    <option th:each="type : ${projectTypes}" th:value="${type.projectTypeId}"
                            th:text="${type.projectTypeName}">Select Project Type
                    </option>
                </select>
            </div>

            <div id="skillCareerContainer"></div>
            <div class="form-group">
                <button type="button" id="addSkillCareer-btn" onclick="addSkillCareer()">プログラミング経歴追加</button>
            </div>

            <br/>

            <button type="submit" id="submit-btn" onclick="handleSubmit(event)">社員情報登録</button>


            <input type="text" id="latitude" style="display: none;" th:field="*{latitude}" readonly/><br/>
            <input type="text" id="longitude" style="display: none;" th:field="*{longitude}" readonly/><br/>
            <div id="map" style="display: none;"></div>
            <input type="date" id="lastProjectEndDate" style="display: none;" th:field="*{lastProjectEndDate}"/><br/>
            <input type="date" id="currentProjectEndDate" style="display: none;"
                   th:field="*{currentProjectEndDate}"/><br/>

        </form>

    </div>
</div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('contactNumber').addEventListener('input', function (event) {
            let input = event.target.value.replace(/-/g, ''); // 현재 입력된 값에서 하이픈을 제거합니다.

            if (input.length > 3 && input.length <= 7) {
                input = input.slice(0, 3) + '-' + input.slice(3); // 4자리 이상일 경우 첫 번째 하이픈을 추가합니다.
            } else if (input.length > 7) {
                input = input.slice(0, 3) + '-' + input.slice(3, 7) + '-' + input.slice(7, 11); // 8자리 이상일 경우 두 번째 하이픈을 추가합니다.
            }

            event.target.value = input; // 하이픈이 포함된 값을 입력 필드에 설정합니다.
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        flatpickr("#hireDate", {
            locale: "ja", // 일본어 설정
            dateFormat: "Y-m-d", // 날짜 형식 (연-월-일)
            altInput: true,
            altFormat: "Y年m月d日" // 화면에 표시될 형식
        });
    });
</script>
</html>
