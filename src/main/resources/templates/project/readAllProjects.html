<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>プロジェクトチーム編成システム</title>
    <style>
        .status-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            margin: 0 5px;
            vertical-align: middle;
        }

        .project-unassigned {
        }

        .project-assigned {
        }

        .project-completed {
        }

        body {
            overflow-y: hidden;
            overflow-x: auto;
            padding: 0;
            margin: 0;
        }

        ul {
            list-style: none;
        }

        .menu {
            background-color: #1e90ff;
            width: 250px;
            height: 100vh;
        }

        .menus > li {
            width: 101%;
            height: 40px;
            justify-content: center;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            text-align: center;
            font-size: 18px;
        }

        .menus li a {
            display: block;
            width: 100%;
            height: 100%;
            text-align: start;
            padding: 15px 20px;
            box-sizing: border-box;
            font-family: 'Meiryo UI',serif;
            font-weight: bold;
        }


        .menus {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        .menu-icon {
            width: 20%;
            height: auto;
            vertical-align: middle;
        }

        .menus li:hover {
            background: linear-gradient(45deg, #1e90ff, #00bfff);
            color: #fff;
            border-top-right-radius: 40px;
            border-bottom-right-radius: 40px;
        }

        .contents {
            background-color: #f5f5f5;
            width: 82vw;
            height: auto;
            border-radius: 15px 15px 0 0;
            overflow-y: auto;
            scrollbar-width: none;
        }

        .contents::-webkit-scrollbar {
            display: none;
        }

        .contents p {
            height: 35px;
            margin-left: 30px;
        }


        .projects {
            width: 98%;;
            height: 85vh;
            margin-left: 1%;
            background: rgba(173, 216, 230, 0.2);
            border: 1px solid rgba(173, 216, 230, 0.3);
            border-radius: 15px 15px 0 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: #333;
            font-family: "Arial", sans-serif;
            text-align: center;
            overflow-y: auto;

            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .projects::-webkit-scrollbar {
            display: none;
        }

        .projects > div {
            display: flex;
            margin-right: 40px;
            overflow: hidden;
            align-items: center;
            border-bottom: 1px solid #c6c6c6;
            transition: background-color 0.3s ease;
        }

        .projects > div:hover {
            background-color: rgba(173, 216, 230, 0.4);
        }

        .project-name,
        .client-company {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            display: inline-block;
        }

        #project-title,
        #project-info .value {
            white-space: normal;
            overflow-wrap: break-word;
        }

        .allocation-header, .allocation {
            min-width: 35px;
            max-width: 35px;
            flex: 0 0 35px;
        }

        .start-date-header, .end-date-header, .start-date, .end-date {
            min-width: 150px;
            max-width: 150px;
            flex: 0 0 150px;
        }

        .project-name-header, .client-company-header, .project-name, .client-company {
            min-width: 24vw;
            max-height: 3vh;
            flex: 0 0 270px;
        }

        .projects > div > div {
            float: left;
            margin: 10px;
            box-sizing: border-box;
            padding-top: 5px;
        }

        .header, .row {
            display: contents;
        }

        .header > div {
            font-family: "Meiryo UI",serif;
            font-weight: bold;
            font-size: 17px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
            text-align: center;
            line-height: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* modal css */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 75%;
            height: auto;
            border-radius: 10pt;
        }

        #project-finish-modal {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            height: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10pt;
        }

        .modal-button {
            font-family: "Noto Sans JP", sans-serif;
            font-size: 14px;
            color: #fff;
            background: linear-gradient(
                    45deg,
                    #4a90e2,
                    #87cefa
            );
            border: none;
            border-radius: 20px;
            padding: 3px 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        .modal-button:hover {
            background: linear-gradient(
                    45deg,
                    #3a7adf,
                    #6bbce5
            );
            transform: scale(1.03);
        }

        .modal-projects > div {
            display: flex;
        }

        #modal-body {
            display: flex;
            flex-direction: column;
        }

        #project-info {
            display: grid;
            grid-template-columns: 50% 50%;
            gap: 10px;
            width: 95%;
            margin: 10px auto;
            border: 1px solid #ddd;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
        }

        #project-info .data-row {
            display: flex;
        }

        #project-info .label, #project-info .value {
            padding: 10px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        .modal-projectRequirements {
            display: block;
        }

        .project-info-left {
            grid-column: 1;
        }

        .project-info-right {
            grid-column: 2;
        }

        #project-info .label {
            font-family: "Meiryo UI",serif;
            background-color: #71b6ff;
            font-weight: bold;
            width: 20%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 10px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        .unassigned-status {
            color: red;
            font-weight: bold;
        }

        #project-info .value {
            width: 70%;
        }

        .modal-projectRequirements div {
            margin-bottom: 10px;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #b7c6ec;
        }

        .skill-info {
            display: flex;
            flex: 1;
            text-align: left;
            align-items: center;
        }

        .skill-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }

        .experience-info {
            flex: 1;
            text-align: center;
        }

        .count-info {
            flex: 1;
            text-align: right;
            font-weight: bold;
            color: black;
        }

        .low-fulfillment {
            color: red;
            font-weight: bold;
        }

        #project-info ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #project-info li {
            margin-bottom: 5px;
        }

        /* requirement-modal */
        #project-requirement-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        #project-requirement-modal .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        /* add-projects button */
        #add-projects {
            margin-left: 960px;
            font-family: "Noto Sans JP", sans-serif;
            font-size: 16px;
            color: #fff;
            background: linear-gradient(
                    45deg,
                    #4a90e2,
                    #87cefa
            );
            border: none;
            border-radius: 20px;
            padding: 7px 14px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        #button-container {
            display: flex;
            gap: 10px;
        }

        /* update-btn */
        #update-btn, #yes-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #6c757d;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        #update-btn, #yes-btn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        #update-btn, #yes-btn:active {
            background-color: #545b62;
            transform: translateY(0);
        }

        #delete-btn, #no-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #ef4747;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        #delete-btn, #no-btn:hover {
            background-color: #b11212;
            transform: translateY(-2px);
        }

        #delete-btn, #no-btn:active {
            background-color: #b11212;
            transform: translateY(0);
        }

        #employeeList-btn {
            transition: transform 0.3s;
        }

        #employeeList-btn:hover {
            transform: translateY(-2px);
        }

        #assign-btn {
            background-color: #ade8ff;
            color: #000000;
            border-color: #c9fff6;
            transition: transform 0.3s;
            border-radius: 5pt;
        }

        #assign-btn:hover {
            background-color: #ade8ff;
            color: #000000;
            border-color: #c9fff6;
            transform: translateY(-2px);
            border-radius: 5pt;
        }

        input[type="text"], select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
            margin-left: 2vw;
            margin-right: 8px;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        input[type="text"]:focus, select:focus {
            border-color: #2980b9;
            outline: none;
            box-shadow: 0 0 4px rgba(41, 128, 185, 0.5);
        }

        select {
            width: auto;
            padding-right: 20px;
        }

        input[type="text"]::placeholder {
            color: #aaa;
        }

        input[type="text"]:hover, select:hover {
            border-color: #2980b9;
        }

        input[type="text"].hidden {
            display: none;
        }

        #filterByProjectName, #filterByProjectId {
            width: 220px;
        }

        #sortProjectsByDate, #filterByStatus {
            width: 180px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #34495e;
        }

        .filter-container {
            display: flex;
            flex-wrap: wrap;
        }

        .hidden {
            display: none;
        }

        .container {
            height: auto;
            width: 95vw;
        }

        .cancel-requirement-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #b7c6ec;
            padding: 10px 0;
            transition: background-color 0.3s ease;
        }

        .cancel-requirement-item:hover {
            background-color: #f0f0f0;
        }

        .cancel-requirement-skill-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .cancel-skill-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        .cancel-requirement-experience-info {
            flex: 1;
            text-align: center;
        }

        .cancel-requirement-count-info {
            flex: 1;
            text-align: right;
        }

        .cancel-requirement-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .cancel-requirement-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 40%;
            margin: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal-requirements-list {
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .complete-button {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s ease;
        }

        .complete-button:hover {
            background-color: #218838;
            transform: scale(1.03);
        }

        .cancel-employees-select {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .cancel-employees-select select {
            width: 75%;
            margin-bottom: 10px;
        }

        .cancel-employees-select button {
            width: 40%;
            padding: 8px 16px;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .cancel-employees-select button:hover {
            background-color: #c9302c
        }

        .projectFinishAndYesOrNoButton {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #assigned-employees-evaluation {
            width: 95%;
            margin: 10px auto;
            border: 1px solid #ddd;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            height: auto;
            max-height: 750pt;
            overflow-y: auto;
            scrollbar-width: none;
        }

        #assigned-employees-evaluation::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        #assigned-employees-evaluation::-webkit-scrollbar-thumb {
            background-color: transparent;
        }

        .employee-table {
            width: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-collapse: collapse;
        }

        .employee-table-header, .employee-table-body {
            display: flex;
            flex-direction: column;
        }

        .employee-table-row {
            display: flex;
            width: 100%;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1px solid #ddd;
        }

        .employee-table-cell {
            flex: 1;
            padding: 8px;
            box-sizing: border-box;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        .employee-table-cell:first-child {
            border-left: none;
        }

        .employee-table-cell:last-child {
            border-right: none;
        }

        .header-cell {
            font-weight: bold;
            background-color: #71b6ff;
            text-align: center;
            border: 1px solid #ddd;
        }

        .header-cell {
            font-weight: bold;
            background-color: #71b6ff;
            text-align: center;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        .header-cell:first-child {
            border-left: none;
        }

        .header-cell:last-child {
            border-right: none;
        }


        #lookOnMap {
            border: none;
            border-radius: 5px;
            background-color: #87cefa;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        #lookOnMap:hover {
            background-color: #6bb5e6;
            transform: translateY(-2px);
        }



    </style>
</head>
<body>
<div class="container" style="display: flex">
    <div class="menu">
        <ul class="menus">
            <li>
                <a href="/index">
                    <img src="/img/dashBoard/home (2).png" alt="" class="menu-icon">
                    メイン·ページ
                </a>
            </li>
            <li>
                <a href="/employees">
                    <img src="/img/dashBoard/businessman.png" alt="" class="menu-icon">
                    社員リスト
                </a>
            </li>
            <li>
                <a href="/readAllProjects">
                    <img src="/img/dashBoard/project (1).png" alt="" class="menu-icon">
                    プロジェクトリスト
                </a>
            </li>
        </ul>
    </div>

    <div class="contents">
        <p style="font-family: 'Meiryo UI',serif;font-weight: bold;font-size: 26px">プロジェクトリスト <span><button th:onclick="createProject()" id="add-projects">プロジェクト登録</button></span>
        </p>

        <div class="filter-container">
            <input type="text" id="filterByProjectName" placeholder="プロジェクト名で検索"
                   oninput="filterByProjectName()">

            <input type="text" id="filterByClientName" placeholder="クライアント会社で検索"
                   oninput="filterByClientName()">

            <select id="sortProjectsByDate" th:onchange="sortProjectsByDate()">
                <option value="startDate" th:selected="${sortBy == 'startDate'}">開始日順</option>
                <option value="endDate" th:selected="${sortBy == 'endDate'}">終了日順</option>
            </select>
            <input type="text" id="filterByProjectId" oninput="filterByProjectId()" style="display: none">
            <select id="filterByStatus" th:onchange="filterByStatus()">
                <option value="" th:selected="${filterStatus == null}">全て</option>
                <option value="-1" th:selected="${filterStatus == -1}">配属必要</option>
                <option value="1" th:selected="${filterStatus == 1}">配属済</option>
                <option value="2" th:selected="${filterStatus == 2}">終了</option>
            </select>
        </div>

        <div class="projects">
            <div class="header">
                <div class="allocation-header" style="visibility: hidden"></div>
                <div class="project-name-header">プロジェクト名</div>
                <div class="client-company-header">クライアント会社</div>
                <div class="start-date-header">開始日</div>
                <div class="end-date-header">終了日</div>
                <div style="visibility: hidden"></div>
                <div style="visibility: hidden"></div>
            </div>
            <div th:class="'project ' + (${p.status == -1} ? 'project-unassigned' : (${p.status == 1} ? 'project-assigned' : (${p.status} == 2 ? 'project-completed' : '')))"
                 th:each="p : ${session.projects}">
                <div class="project-id" th:text="${p.projectId}" style="display: none"></div>
                <div class="status" th:text="${p.status}" style="display: none"></div>

                <div class="status-icon allocation" th:switch="${p.status}">
                    <img th:case="-1" th:src="@{/img/project/need.png}" alt="配属必要"/>
                    <img th:case="1" th:src="@{/img/project/matched.png}" alt="配属済"/>
                    <img th:case="2" th:src="@{/img/project/done.png}" alt="終了"/>
                </div>
                <div class="project-name" th:text="${p.projectName}"></div>
                <div class="client-company" th:text="${p.clientCompany}"></div>
                <div class="start-date" th:text="${p.startDate}"></div>
                <div class="end-date" th:text="${p.endDate}"></div>
                <div>
                    <button class="modal-button" th:onclick="'showProjectDetails('+${p.projectId}+')'">詳細
                    </button>
                </div>
                <div>
                    <button th:class="'complete-button' + (${p.status != 1} ? ' hidden' : '')">完了
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span style="display: none;" class="close-button" onclick="closeModal()">&times;</span>
            <div style="display: flex; justify-content: space-between; align-items: center">
                <div style="width: 55%">
                    <span id="project-title" style="font-family:'Meiryo UI',serif;font-weight: bold; font-size: 25px;"></span>
                    <span id="project-dates" style="margin-left: 10px; font-size: 18px; color: grey;"></span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="assign-btn" onclick="navigateToMatchManagement()">配属ページへ</button>
                    <button id="employeeList-btn"> 配属社員リストへ
                    </button>
                    <button id="update-btn">修正</button>
                    <button id="delete-btn">削除</button>
                </div>
            </div>
            <div id="modal-body">
            </div>
        </div>
    </div>

    <div id="project-requirement-modal" class="cancel-requirement-modal">
        <div class="cancel-requirement-modal-content">
            <h3>配属中のスキルを選んでください</h3>
            <div id="modal-requirements-list" class="modal-requirements-list">
            </div>
        </div>
    </div>

    <div id="complete-modal" class="modal">
        <div class="modal-content" id="project-finish-modal">
            <span style="display: none;" class="close-button" onclick="closeCompleteModal()">&times;</span>
            <div id="complete-modal-body">
            </div>
        </div>
    </div>
</div>


<script th:inline="javascript">
    const skillIconMap = {
        'java': '/img/skillicons/java-icon.png',
        'javascript': '/img/skillicons/javascript-icon.png',
        'python': '/img/skillicons/python-icon.png',
        'ruby': '/img/skillicons/ruby-icon.png',
        'php': '/img/skillicons/php-icon.png',
        'go': '/img/skillicons/go-icon.png',
        'c#': '/img/skillicons/c-sharp-icon.png',
        'html': '/img/skillicons/html-icon.png',
        'node.js': '/img/skillicons/node-js-icon.png',
        'css': '/img/skillicons/css-icon.png',
        'vue.js': '/img/skillicons/vue-js-icon.png',
        'react': '/img/skillicons/react-icon.png'
    };

    function showProjectDetails(projectId) {

        fetch(`/getInfoByProjectID?id=${projectId}`)
            .then(response => response.json())
            .then(data => {
                console.log(data)

                document.getElementById('project-title').textContent = `${data.project.projectId} . ${data.project.projectName}`;
                document.getElementById('project-dates').textContent = `${data.project.startDate} ~ ${data.project.endDate}`;

                document.getElementById('employeeList-btn').onclick = function () {
                    readEmployeesByProjectId(projectId);
                };

                let statusText;
                let statusClass = "";
                switch (data.project.status) {
                    case -1:
                        statusText = "配属必要";
                        statusClass = "unassigned-status";
                        break;
                    case 1:
                        statusText = "配属済";
                        break;
                    case 2:
                        statusText = "終了";
                        break;
                    default:
                        statusText = "ステータスが分かりません。";
                }

                const modalBody = document.getElementById('modal-body');
                modalBody.innerHTML = `
<div id="project-info">
    <div class="project-info-left">
        <div class="data-row">
            <div class="label">勤務先住所:</div>
            <div class="value">${data.project.workLocation}  <button  id="lookOnMap" onclick="visitGoogleMap(${data.project.latitude}, ${data.project.longitude})">地図で見る</button>
            </div>
        </div>
        <div class="data-row">
            <div class="label">顧客先会社:</div>
            <div class="value">${data.project.clientCompany}</div>
        </div>
        <div class="data-row">
            <div class="label">顧客先担当者:</div>
            <div class="value">${data.project.contactName}</div>
        </div>
        <div class="data-row">
            <div class="label">担当者連絡先:</div>
            <div class="value">${data.project.contactPhone}</div>
        </div>
        <div class="data-row">
            <div class="label">ステータス:</div>
            <div class="value ${statusClass}">${statusText}</div>
        </div>
        <div class="data-row">
            <div class="label">案件種類:</div>
            <div class="value">${data.project.projectType.projectTypeName}</div>
        </div>
    </div>
    <div class="project-info-right">
        <div class="data-row">
            <div class="label">スキル要件:</div>
            <div class="value modal-projectRequirements">
                ${data.projectRequirements.map(req => `
                <div class="requirement-item">
                    <div class="skill-info">
                      <img class="skill-icon" data-skill-name="${req.skill.skillName.toLowerCase()}" alt="${req.skill.skillName}">
                    <span>${req.skill.skillName}</span>
                    </div>
                    <div class="experience-info">
                    必要経験: ${(req.requiredExperience / 12).toFixed(1)} 年
                    </div>
                     <div class="count-info ${req.fulfilledCount < req.requiredCount ? 'low-fulfillment' : ''}">
                    充足人数: ${req.fulfilledCount} / ${req.requiredCount}
                    </div>
                </div>
                `).join('')}
            </div>
        </div>
        <div class="data-row">
            <div class="label">配属中従業員:</div>
            <div class="value cancel-employees-select">
                <select id="employeeDropdown">
                    <option value="">社員選択</option>
                    ${data.employeesProjects.map((empProj, index) => `
                        <option value="${index}">${empProj.employeeName || 'N/A'} : ${empProj.skill.skillName}に配属中</option>
                    `).join('')}
                </select>
                <button onclick='cancelSelectedAssignment(${data.projectId}, ${JSON.stringify(data.epID)})'>配属キャンセル</button>
            </div>
        </div>
    </div>
</div>`;

                document.querySelectorAll('.skill-icon').forEach(imgElement => {
                    const skillName = imgElement.getAttribute('data-skill-name');
                    if (skillIconMap[skillName]) {
                        imgElement.src = skillIconMap[skillName];
                    }
                });

                document.getElementById('update-btn').addEventListener('click', function () {
                    updateProject(projectId);
                })

                document.getElementById('delete-btn').addEventListener('click', function () {
                    deleteProject(projectId);
                })
                openModal();
            })
            .catch(error => {
                console.error('プロジェクトの詳細を取得中にエラーが発生しました:', error);
            });
    }

    function visitGoogleMap(latitude, longitude) {
        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${latitude},${longitude}`;
        window.open(googleMapsUrl, '_blank');
    }

    function cancelSelectedAssignment(projectId, epID) {

        const employeeDropdown = document.getElementById('employeeDropdown');
        const selectedIndex = employeeDropdown.value;
        if (selectedIndex === "") {
            alert("社員を選んでください。");
            return;
        }
        const employeeId = epID[selectedIndex];
        fetch(`/getProjectRequirements?projectId=${projectId}`)
            .then(response => response.json())
            .then(projectRequirements => {
                if (Array.isArray(projectRequirements)) {
                    openProjectRequirementModal(projectId, employeeId, projectRequirements);
                } else {
                    console.error("エラー: projectRequirements が配列ではありません");
                }
            })
            .catch(error => {
                console.error('要求スキルの取得中にエラーが発生しました:', error);
            });
    }

    function openProjectRequirementModal(projectId, employeeId, projectRequirements) {
        const modalRequirementsList = document.getElementById('modal-requirements-list');
        modalRequirementsList.innerHTML = '';

        projectRequirements.forEach(req => {
            const requirementElement = document.createElement('div');
            requirementElement.classList.add('cancel-requirement-item');
            requirementElement.innerHTML = `
            <div class="cancel-requirement-skill-info">
             <input type="radio" name="projectRequirement" value="${req.id}">
                <img class="cancel-skill-icon" data-skill-name="${req.skill.skillName.toLowerCase()}" alt="${req.skill.skillName}">
                <span>${req.skill.skillName}</span>
            </div>
            <div class="cancel-requirement-experience-info">
                必要経験: ${(req.requiredExperience / 12).toFixed(1)} 年
            </div>
            <div class="cancel-requirement-count-info ${req.fulfilledCount < req.requiredCount ? 'low-fulfillment' : ''}">
                充足人数: ${req.fulfilledCount} / ${req.requiredCount}
            </div>
        `;
            requirementElement.addEventListener('click', () => {
                const radioInput = requirementElement.querySelector('input[type="radio"]');
                radioInput.checked = true;
            });

            modalRequirementsList.appendChild(requirementElement);
        });

        document.querySelectorAll('.cancel-skill-icon').forEach(imgElement => {
            const skillName = imgElement.getAttribute('data-skill-name');
            if (skillIconMap[skillName]) {
                imgElement.src = skillIconMap[skillName];
            }
        });


        const confirmButton = document.createElement('button');
        confirmButton.textContent = '配属キャンセル';
        confirmButton.style.width = '20%';
        confirmButton.style.margin = '3% auto 0 auto';

        confirmButton.style.backgroundColor = '#d9534f';
        confirmButton.style.color = 'white';
        confirmButton.style.border = 'none';
        confirmButton.style.borderRadius = '5px';
        confirmButton.style.cursor = 'pointer';

        confirmButton.onmouseover = function () {
            confirmButton.style.backgroundColor = '#c9302c';
        };

        confirmButton.onmouseout = function () {
            confirmButton.style.backgroundColor = '#d9534f';
        };

        confirmButton.onclick = function () {
            confirmCancelAssignment(projectId, employeeId);
        };

        modalRequirementsList.appendChild(confirmButton);

        document.getElementById('project-requirement-modal').style.display = 'block';
    }

    function confirmCancelAssignment(projectId, employeeId) {
        const selectedRequirement = document.querySelector('input[name="projectRequirement"]:checked');
        if (!selectedRequirement) {
            alert('項目を選んでください。');
            return;
        }

        const projectRequirementsId = selectedRequirement.value;
        if (confirm('本当に配属をキャンセルしますか?')) {
            cancelAssignment(projectId, employeeId, projectRequirementsId);
            closeProjectRequirementModal();
        }
    }

    function cancelAssignment(projectId, employeeId, projectRequirementsId) {
        console.log(projectId)
        console.log(employeeId)
        console.log(projectRequirementsId)

        const url = `/matchCancel?projectId=${projectId}&employeeId=${employeeId}&projectRequirementsId=${projectRequirementsId}`;

        fetch(url, {
            method: 'GET'
        })
            .then(response => response.text())
            .then(result => {
                if (result === "キャンセル成功") {
                    alert("配属がキャンセルされました。");
                    location.reload()
                } else {
                    alert("配属がキャンセルが失敗しました。");
                }
            })
            .catch(error => {
                console.error('配属キャンセル中にエラーが発生しました:', error);
                alert("配属がキャンセルの途中エラーが発生しました。");
            });
    }


    function closeProjectRequirementModal() {
        document.getElementById('project-requirement-modal').style.display = 'none';
    }

    function filterByStatus() {
        const selectedStatus = document.getElementById('filterByStatus').value;
        const projects = document.querySelectorAll('.projects > .project');

        projects.forEach(project => {
            const projectStatus = project.querySelector('.status').textContent.trim();

            if (selectedStatus === "" || projectStatus === selectedStatus) {
                project.style.display = '';
            } else {
                project.style.display = 'none';
            }
        });
    }

    function filterByProjectId() {
        const inputId = document.getElementById('filterByProjectId').value.trim();
        const projects = document.querySelectorAll('.projects > .project');

        projects.forEach(project => {
            const projectId = project.querySelector('.project-id').textContent.trim();

            if (projectId === inputId || inputId === "") {
                project.style.display = '';
            } else {
                project.style.display = 'none';
            }
        });
    }

    function filterByProjectName() {
        const filter = document.getElementById('filterByProjectName').value.toLowerCase();
        const projects = document.querySelectorAll('.projects > .project');

        projects.forEach(project => {
            const projectName = project.querySelector('.project-name').textContent.toLowerCase();
            if (projectName.includes(filter)) {
                project.style.display = "";
            } else {
                project.style.display = "none";
            }
        });
    }

    function filterByClientName() {
        const filter = document.getElementById('filterByClientName').value.toLowerCase();
        const projects = document.querySelectorAll('.projects > .project');

        projects.forEach(project => {
            const clientName = project.querySelector('.client-company').textContent.toLowerCase();
            if (clientName.includes(filter)) {
                project.style.display = "";
            } else {
                project.style.display = "none";
            }
        });
    }

    function sortProjectsByDate() {
        const sortBy = document.getElementById('sortProjectsByDate').value;
        const projects = Array.from(document.querySelectorAll('.projects > .project'));
        const projectsContainer = document.querySelector('.projects');

        const currentDate = new Date();
        const sortClass = sortBy === 'startDate' ? 'start-date' : 'end-date';

        const futureProjects = projects.filter(project => {
            const projectDate = new Date(project.querySelector(`.${sortClass}`).textContent);
            return projectDate >= currentDate;
        });

        const pastProjects = projects.filter(project => {
            const projectDate = new Date(project.querySelector(`.${sortClass}`).textContent);
            return projectDate < currentDate;
        });

        futureProjects.sort((a, b) => {
            const aValue = new Date(a.querySelector(`.${sortClass}`).textContent);
            const bValue = new Date(b.querySelector(`.${sortClass}`).textContent);
            return aValue - bValue;
        });

        pastProjects.sort((a, b) => {
            const aValue = new Date(a.querySelector(`.${sortClass}`).textContent);
            const bValue = new Date(b.querySelector(`.${sortClass}`).textContent);
            return aValue - bValue;
        });

        futureProjects.concat(pastProjects).forEach(project => {
            projectsContainer.appendChild(project);
        });

        pastProjects.forEach(project => {
            projectsContainer.appendChild(project);
        });
    }

    function createProject() {
        location.href = "/createProject"
    }

    function updateProject(projectId) {
        location.href = "/updateProject?id=" + projectId;
    }

    function deleteProject(projectId) {
        if (confirm("本当にプロジェクトを削除しますか？")) {
            location.href = "/deleteProject?id=" + projectId;
        }
    }

    function readEmployeesByProjectId(projectId) {
        location.href = "/employees?projectId=" + projectId;
    }

    document.querySelectorAll('.complete-button').forEach(button => {
        button.addEventListener('click', function () {
            const projectId = this.closest('.project').querySelector('.project-id').textContent.trim();
            showCompleteModal(projectId, this);
        });
    });

    function showCompleteModal(projectId, buttonElement) {

        const rowElement = buttonElement.closest('.project');
        const endDateElement = rowElement.querySelector('.end-date');

        const projectEndDate = new Date(endDateElement.textContent.trim());

        const currentDate = new Date();

        if (currentDate < projectEndDate) {
            alert("まだ終了日以前です。");
            return;
        }

        const completeModalBody = document.getElementById('complete-modal-body');
        completeModalBody.innerHTML = `
<div class="projectFinishAndYesOrNoButton">
<div id="project-finish-title" style="font-family:'Meiryo UI', serif;font-weight: bold; font-size: 20px;">プロジェクトを完了処理しますか？</div>
                            <div id="complete-button-container">
                                <button id="yes-btn">はい</button>
                                <button id="no-btn" onclick="closeCompleteModal()">いいえ</button>
                            </div>
          </div>
<div id="assigned-employees-evaluation">
                            <div id="assigned-employees"></div>
</div>
                            <div id="assigned-projects"></div>





`;
        fetch(`/getInfoByProjectID?id=${projectId}`)
            .then(response => response.json())
            .then(data => {
                console.log("Received data:", data);
                const employeesProjects = data.employeesProjects;
                const epID = data.epID;

                console.log(epID);

                const projectFinishTitle = document.getElementById('project-finish-title');
                projectFinishTitle.innerHTML = `プロジェクト「${data.project.projectName}」を完了処理しますか？`;

                const employeesDiv = document.getElementById('assigned-employees');
                employeesDiv.innerHTML = `
    <p style="font-family: 'Meiryo UI', serif;font-weight:bold;font-size:15px">参加社員の評価点数入力してください</p>
    <div class="employee-table">
    <div class="employee-table-header">
        <div class="employee-table-row" style="font-family:'Meiryo UI', serif;font-weight:bold;">
            <div class="employee-table-cell header-cell">社員番号また名前</div>
            <div class="employee-table-cell header-cell">担当プログラミング言語</div>
            <div class="employee-table-cell header-cell">評価点数</div>
        </div>
    </div>
    <div class="employee-table-body">
        ${employeesProjects.map((ep, index) => `
            <div class="employee-table-row">
                <div class="employee-table-cell">${epID[index]}.${ep.employeeName}</div>
                <div class="employee-table-cell">${ep.skill.skillName}</div>
                <div class="employee-table-cell">
                    <select class="star-point" id="star-point-${index}"
                    style="padding: 0; margin:0 ">
                        <option value="" selected>選択</option>
                        ${[...Array(11)].map((_, i) => `
                            <option value="${(i / 2).toFixed(1)}">${(i / 2).toFixed(1)}</option>`).join('')}
                    </select> / 5
                </div>
            </div>`).join('')}
    </div>
</div>`;


                document.getElementById('yes-btn').addEventListener('click', function () {
                    const allSelects = document.querySelectorAll('select[id^="star-point-"]');
                    let allValid = true;

                    for (const select of allSelects) {
                        if (select.value === "") {
                            allValid = false;
                            alert('すべての社員に点数を選択してください。');
                            select.focus();
                            break;
                        }
                    }


                    if (allValid) {
                        const projectParticipantsInfos = employeesProjects.map((ep, index) => {
                            const starPoint = document.getElementById(`star-point-${index}`).value;
                            const result = {
                                employeeId: epID[index],
                                starPoint: parseFloat(starPoint),
                                skillId: ep.skill.skillId,
                                projectDuration: parseFloat(ep.projectDuration)
                            };
                            console.log(result);
                            return result;
                        });
                        completeProject(projectId, projectParticipantsInfos);
                    }

                });
            })
            .catch(error => {
                console.error('プロジェクト情報の取得中にエラーが発生しました:', error);
            });

        openCompleteModal();
    }

    function completeProject(projectId, projectParticipantsInfos) {
        console.log(projectId, projectParticipantsInfos)
        fetch(`/completeProject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({projectId: projectId, projectParticipantsInfos: projectParticipantsInfos})
        })
            .then(response => response.text())
            .then(text => {
                if (text === "プロジェクトが完了処理されました") {
                    closeCompleteModal();
                    window.location.href = '/readAllProjects';
                } else {
                    console.error('予期しないレスポンス:', text);
                }
            })
            .catch(error => {
                console.error('プロジェクトの完了中にエラーが発生しました:', error);
            });
    }

    function navigateToMatchManagement() {
        window.location.href = /*[[@{/matchManagement}]]*/ '/matchManagement';
    }

    function openModal() {
        document.getElementById('modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    function openCompleteModal() {
        document.getElementById('complete-modal').style.display = 'block';
    }

    function closeCompleteModal() {
        document.getElementById('complete-modal').style.display = 'none';
    }

    const imminentStartDays = /*[[${imminentStartDays}]]*/ 0;

    const imminentEndDays = /*[[${imminentEndDays}]]*/ 0;

    function updateProjectDatesStyles() {
        const projects = document.querySelectorAll('.projects > .project');
        const currentDate = new Date();
        currentDate.setHours(0, 0, 0, 0);

        projects.forEach(project => {
            const startDateElement = project.querySelector('.start-date');
            const endDateElement = project.querySelector('.end-date');
            const startDate = new Date(startDateElement.textContent.trim());
            const endDate = new Date(endDateElement.textContent.trim());
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);

            const imminentStart = (startDate - currentDate) / (1000 * 60 * 60 * 24);
            const imminentEnd = (endDate - currentDate) / (1000 * 60 * 60 * 24);

            if (imminentStart <= imminentStartDays && imminentStart >= 0) {
                startDateElement.style.color = 'orange';
                startDateElement.style.fontWeight = 'bold';
            }
            if (imminentEnd <= imminentEndDays && imminentEnd >= 0) {
                endDateElement.style.color = 'red';
                endDateElement.style.fontWeight = 'bold';
            }
        });

    }

    window.onclick = function (event) {
        if (event.target == document.getElementById('modal')) {
            closeModal();
        } else if (event.target == document.getElementById('project-requirement-modal')) {
            closeProjectRequirementModal();
        }
    }
    window.onload = function () {
        updateProjectDatesStyles();
        filterByStatus();
        sortProjectsByDate();
    }

</script>
</body>
</html>