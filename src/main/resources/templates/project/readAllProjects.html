<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>プロジェクトチーム編成システム</title>
    <style>
        .status-icon img {
            width: 20px; /* 이미지의 너비를 24px로 설정 */
            height: 20px; /* 이미지의 높이를 24px로 설정 */
            object-fit: contain; /* 이미지 비율을 유지하면서 크기 조정 */
            margin: 0 5px; /* 이미지 주위에 약간의 여백을 추가 */
            vertical-align: middle; /* 텍스트와 함께 있을 때 이미지의 세로 정렬을 중앙으로 설정 */
        }

        /* 상태에 따른 css 설정 */
        .project-unassigned {
        }

        .project-assigned {
        }

        .project-completed {
        }

        body {
            overflow-y: hidden; /* Y축 스크롤 비활성화 */
            overflow-x: auto;   /* X축 스크롤 활성화 */
            padding: 0;
            margin: 0;
        }

        ul {
            list-style: none;
        }

        .menu {
            background-color: #1e90ff;
            width: 250px;
            height: 100vh;
        }

        .menus > li {
            width: 200px;
            height: 40px;
            justify-content: center;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            text-align: center;
            font-size: 18px;
        }

        .menus li a {
            display: block;
            width: 100%;
            height: 100%;
            text-align: center; /* 텍스트 가운데 정렬 */
            padding: 15px 20px; /* a 요소에 패딩을 적용 */
            box-sizing: border-box;
        }


        .menus {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menus li:hover {
            background: linear-gradient(45deg, #1e90ff, #00bfff);
            color: #fff;
            border-top-right-radius: 40px;
            border-bottom-right-radius: 40px;
        }

        .contents {
            background-color: #f5f5f5;
            width: 1170px;
            height: auto;
            border-radius: 15px 15px 0 0;
            overflow-y: auto;
            scrollbar-width: none;
        }

        .contents::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .contents p {
            height: 35px;
            margin-left: 30px;
        }


        .projects {
            width: 98%;;
            height: 82vh;
            margin-left: 1%;
            background: rgba(173, 216, 230, 0.2); /* 하늘색 투명 배경 */
            border: 1px solid rgba(173, 216, 230, 0.3); /* 투명한 경계 */
            border-radius: 15px 15px 0 0;
            backdrop-filter: blur(10px); /* 글라스 효과 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* 약간의 그림자 */
            color: #333; /* 어두운 글자색 */
            font-family: "Arial", sans-serif; /* 깔끔한 폰트 */
            text-align: center;
            overflow-y: auto; /* 수직 스크롤바 추가 */
        }

        .projects > div {
            display: flex;
            margin-right: 40px;
            overflow: hidden; /* Clearfix 효과를 위해 추가 */
            align-items: center;
            border-bottom: 1px solid #c6c6c6;
        }

        .allocation-header, .allocation {
            min-width: 35px;
            max-width: 35px;
            flex: 0 0 35px;
        }

        .start-date-header, .end-date-header, .start-date, .end-date {
            min-width: 150px;
            max-width: 150px;
            flex: 0 0 150px;
        }

        .project-name-header, .client-company-header, .project-name, .client-company {
            min-width: 270px;
            max-width: 270px;
            flex: 0 0 270px;
        }

        .projects > div > div {
            margin-left: 10px;
            margin-right: 10px;
            float: left;
            width: 200px; /* 각 div의 고정된 너비 */
            margin-top: 10px; /* 간격을 주기 위해 추가 */
            margin-bottom: 10px; /* 간격을 주기 위해 추가 */
            box-sizing: border-box; /* 패딩과 테두리를 포함한 크기 계산 */
            align-items: center; /* 텍스트 상하 중앙 정렬 */
            padding-top: 5px;
            flex-direction: column;
        }

        .header, .row {
            display: contents; /* 부모 요소를 제거하고 자식 요소들을 해당 위치에 배치 */
        }

        .header > div {
            font-weight: bold;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
            text-align: center; /* 텍스트 좌우 중앙 정렬 */
            line-height: 40px; /* 상하 중앙 정렬을 위해 div 높이와 동일하게 설정 */
            height: 40px; /* 각 div의 높이 설정 */
            display: flex; /* flexbox를 사용하여 상하 중앙 정렬 */
            align-items: center; /* 상하 중앙 정렬 */
            justify-content: center; /* 좌우 중앙 정렬 */
        }

        /* 모달 css */

        .modal {
            display: none; /* 숨김 처리 */
            position: fixed; /* 모달을 화면 중앙에 고정 */
            z-index: 1; /* 다른 콘텐츠 위에 표시 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4); /* 투명한 배경 */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 중앙 정렬 */
            padding: 20px;
            border: 1px solid #888;
            width: 75%;
            height: auto;
            border-radius: 10pt;
        }

        .modal-button {
            font-family: "Noto Sans JP", sans-serif; /* 일본어 텍스트에 어울리는 글꼴 사용 */
            font-size: 14px; /* 글자 크기 */
            color: #fff; /* 텍스트 색상 */
            background: linear-gradient(
                    45deg,
                    #4a90e2, /* 파란색 계열 시작 색상 */ #87cefa /* 파란색 계열 끝 색상 */
            ); /* 버튼 배경색 그라데이션 */
            border: none; /* 기본 테두리 제거 */
            border-radius: 20px; /* 둥근 테두리 */
            padding: 3px 8px; /* 내부 여백 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 상자 그림자 */
            cursor: pointer; /* 커서 변경 */
            transition: background 0.3s ease, transform 0.3s ease; /* 부드러운 전환 효과 */
        }

        .modal-projects > div {
            display: flex;
        }

        #modal-body {
            display: flex;
            flex-direction: column;
        }

        #project-info {
            display: grid;
            grid-template-columns: 50% 50%;
            gap: 10px;
            width: 95%;
            margin: 10px auto;
            border: 1px solid #ddd;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
        }

        #project-info .data-row {
            display: flex;
        }

        #project-info .label, #project-info .value {
            padding: 10px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        .modal-projectRequirements {
            display: block;
        }

        .project-info-left {
            grid-column: 1;
        }

        .project-info-right {
            grid-column: 2;
        }

        #project-info .label {
            background-color: #71b6ff;
            font-weight: bold;
            width: 150px; /* 가로 길이를 150px로 설정 */
            white-space: nowrap; /* 줄바꿈 방지 */
            overflow: hidden; /* 넘치는 텍스트는 숨김 */
            text-overflow: ellipsis; /* 넘치는 텍스트에 ... 표시 */
            padding: 10px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        .unassigned-status {
            color: red;
            font-weight: bold;
        }

        #project-info .value {
            width: 80%;
        }

        .modal-projectRequirements div {
            margin-bottom: 10px;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #b7c6ec;
        }

        .skill-info {
            display: flex;
            flex: 1;
            text-align: left; /* 왼쪽 정렬 */
            align-items: center;
        }

        .skill-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }

        .experience-info {
            flex: 1;
            text-align: center; /* 가운데 정렬 */
        }

        .count-info {
            flex: 1;
            text-align: right; /* 오른쪽 정렬 */
            font-weight: bold; /* 기본적으로 글씨를 굵게 설정 */
            color: black; /* 기본적으로 검은색 글씨 */
        }

        .low-fulfillment {
            color: red;
            font-weight: bold;
        }

        #project-info ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #project-info li {
            margin-bottom: 5px;
        }

        /* 매칭 취소를 위한 프로젝트 요구사항 선택 모달 */

        #project-requirement-modal {
            display: none; /* 숨김 처리 */
            position: fixed; /* 모달을 화면 중앙에 고정 */
            z-index: 1; /* 다른 콘텐츠 위에 표시 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4); /* 투명한 배경 */
        }

        #project-requirement-modal .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 중앙 정렬 */
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        /* 프로젝트 추가 버튼 스타일 */

        #add-projects {
            margin-left: 960px;
            font-family: "Noto Sans JP", sans-serif; /* 일본어 텍스트에 어울리는 글꼴 사용 */
            font-size: 16px; /* 글자 크기 */
            color: #fff; /* 텍스트 색상 */
            background: linear-gradient(
                    45deg,
                    #4a90e2, /* 파란색 계열 시작 색상 */ #87cefa /* 파란색 계열 끝 색상 */
            ); /* 버튼 배경색 그라데이션 */
            border: none; /* 기본 테두리 제거 */
            border-radius: 20px; /* 둥근 테두리 */
            padding: 7px 14px; /* 내부 여백 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 상자 그림자 */
            cursor: pointer; /* 커서 변경 */
            transition: background 0.3s ease, transform 0.3s ease; /* 부드러운 전환 효과 */
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        #button-container {
            display: flex;
            gap: 10px;
        }

        /* update-btn 스타일 */
        #update-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #6c757d; /* 회색 계열 */
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        /* update-btn 호버 효과 */
        #update-btn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        /* update-btn 활성화 효과 */
        #update-btn:active {
            background-color: #545b62;
            transform: translateY(0);
        }

        /* delete-btn 스타일 */
        #delete-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #ef4747;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        /* delete-btn 호버 효과 */
        #delete-btn:hover {
            background-color: #b11212;
            transform: translateY(-2px);
        }

        /* delete-btn 활성화 효과 */
        #delete-btn:active {
            background-color: #b11212;
            transform: translateY(0);
        }

        #employeeList-btn {
            transition: transform 0.3s;
        }

        #employeeList-btn:hover {
            transform: translateY(-2px);
        }

        #assign-btn {
            background-color: #ade8ff;
            color: #000000;
            border-color: #c9fff6;
            transition: transform 0.3s;
            border-radius: 5pt;
        }

        #assign-btn:hover {
            background-color: #ade8ff;
            color: #000000;
            border-color: #c9fff6;
            transform: translateY(-2px);
            border-radius: 5pt;
        }

        input[type="text"], select {
            margin-left: 30px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        input[type="text"]:focus, select:focus {
            border-color: #2980b9;
            outline: none;
            box-shadow: 0 0 4px rgba(41, 128, 185, 0.5);
        }

        select {
            width: auto;
            padding-right: 20px;
        }

        input[type="text"]::placeholder {
            color: #aaa;
        }

        input[type="text"]:hover, select:hover {
            border-color: #2980b9;
        }

        input[type="text"].hidden {
            display: none;
        }

        /* 레이아웃 조정 */
        #filterByProjectName, #filterByProjectId {
            width: 220px;
        }

        #sortProjectsByDate, #filterByStatus {
            width: 180px;
        }

        /* 라벨 스타일링 */
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #34495e;
        }

        /* 전체 필터 및 정렬 섹션 스타일 */

        .filter-container {
            display: flex;
            flex-wrap: wrap;
        }

        .hidden {
            display: none;
        }

        .container{
            height: auto;
            width: 95vw
        ;
        }


    </style>
</head>
<body>
<div class="container" style="display: flex">
    <div class="menu">
        <ul class="menus">
            <li><a href="/index">MainPage</a></li>
            <li><a href="/employees">社員リスト</a></li>
            <li><a href="/readAllProjects">Projects</a></li>
        </ul>
    </div>

    <div class="contents">
        <p style="font-size: 26px">プロジェクトリスト <span><button th:onclick="createProject()" id="add-projects">プロジェクト追加</button></span>
        </p>

        <!--        필터링 및 정렬        -->
        <div class="filter-container">
            <input type="text" id="filterByProjectName" placeholder="프로젝트 이름 검색" oninput="filterByProjectName()">

            <input type="text" id="filterByClientName" placeholder="고객사 이름 검색" oninput="filterByClientName()">

            <select id="sortProjectsByDate" th:onchange="sortProjectsByDate()">
                <option value="startDate" th:selected="${sortBy == 'startDate'}">프로젝트 시작일 순</option>
                <option value="endDate" th:selected="${sortBy == 'endDate'}">프로젝트 종료일 순</option>
            </select>
            <!--    직접 검색하지 않고 아이디 값 받아와서 검색할 때     -->
            <input type="text" id="filterByProjectId" oninput="filterByProjectId()" style="display: none">
            <!--        프로젝트 상태에 따라 필터링         -->
            <select id="filterByStatus" th:onchange="filterByStatus()">
                <option value="" th:selected="${filterStatus == null}">모든 상태</option>
                <option value="-1" th:selected="${filterStatus == -1}">미배정</option>
                <option value="1" th:selected="${filterStatus == 1}">배정완료</option>
                <option value="2" th:selected="${filterStatus == 2}">완료</option>
            </select>
        </div>

        <div class="projects">
            <div class="header">
                <div class="allocation-header" style="visibility: hidden"></div>
                <div class="project-name-header">プロジェクト名</div>
                <div class="client-company-header">クライアント会社</div>
                <div class="start-date-header">開始日</div>
                <div class="end-date-header">終了日</div>
                <div style="visibility: hidden"></div>
                <div style="visibility: hidden"></div>
            </div>
            <div th:class="'project ' + (${p.status == -1} ? 'project-unassigned' : (${p.status == 1} ? 'project-assigned' : (${p.status} == 2 ? 'project-completed' : '')))"
                 th:each="p : ${session.projects}">
                <div class="project-id" th:text="${p.projectId}" style="display: none"></div>
                <div class="status" th:text="${p.status}" style="display: none"></div>

                <div class="status-icon allocation" th:switch="${p.status}">
                    <img th:case="-1" th:src="@{/img/project/need.png}" alt="배정필요"/>
                    <img th:case="1" th:src="@{/img/project/matched.png}" alt="배정완료"/>
                    <img th:case="2" th:src="@{/img/project/done.png}" alt="프로젝트 완료"/>
                </div>
                <div class="project-name" th:text="${p.projectName}"></div>
                <div class="client-company" th:text="${p.clientCompany}"></div>
                <div class="start-date" th:text="${p.startDate}"></div>
                <div class="end-date" th:text="${p.endDate}"></div>
                <div>
                    <button class="modal-button" th:onclick="'showProjectDetails('+${p.projectId}+')'">詳細
                    </button>
                </div>
                <div>
                    <button th:class="'complete-button' + (${p.status != 1} ? ' hidden' : '')"
                            th:onclick="'showCompleteModal('+${p.projectId}+')'">完了
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달 팝업 -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span style="display: none;" class="close-button" onclick="closeModal()">&times;</span>
            <!-- 새로운 제목 영역 추가 -->
            <div style="display: flex; justify-content: space-between; align-items: center">
                <div>
                    <span id="project-title" style="font-weight: bold; font-size: 25px;"></span>
                    <span id="project-dates" style="margin-left: 10px; font-size: 18px; color: grey;"></span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="assign-btn" onclick="navigateToMatchManagement()">배정 페이지로 이동</button>
                    <button id="employeeList-btn" th:onclick="'readEmployeesByProjectId('+${session.projectId}+')'"> 참여
                        사원 상세보기
                    </button>
                    <button id="update-btn">수정</button>
                    <button id="delete-btn">삭제</button>
                </div>
            </div>
            <div id="modal-body">
                <!-- 여기에 동적으로 내용이 추가됩니다 -->
            </div>
        </div>
    </div>

    <!-- 배정 취소를 위한 프로젝트 요구사항 선택 모달 -->
    <div id="project-requirement-modal" style="display: none;">
        <div style="background-color: white; padding: 20px; border-radius: 8px;">
            <h3>프로젝트 요구사항 선택</h3>
            <div id="modal-requirements-list">
                <!-- 여기서 요구사항 목록을 렌더링 -->
            </div>
            <button onclick="closeProjectRequirementModal()">닫기</button>
        </div>
    </div>

    <!-- 완료 모달 팝업 -->
    <div id="complete-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCompleteModal()">&times;</span>
            <div id="complete-modal-body">
                <!-- 여기에 동적으로 내용이 추가됩니다 -->
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    function showProjectDetails(projectId) {

        fetch(`/getInfoByProjectID?id=${projectId}`)
            .then(response => response.json())
            .then(data => {
                console.log(data)

                document.getElementById('project-title').textContent = `${data.project.projectId} . ${data.project.projectName}`;
                document.getElementById('project-dates').textContent = `${data.project.startDate} ~ ${data.project.endDate}`;

                let statusText;
                let statusClass = "";
                switch (data.project.status) {
                    case -1:
                        statusText = "배정 필요(미배정)";
                        statusClass = "unassigned-status";
                        break;
                    case 1:
                        statusText = "배정 완료";
                        break;
                    case 2:
                        statusText = "프로젝트 종료";
                        break;
                    default:
                        statusText = "알 수 없음"; // 예상치 못한 값에 대한 기본값
                }

                const modalBody = document.getElementById('modal-body');
                modalBody.innerHTML = `
<div id="project-info">
    <div class="project-info-left">
        <div class="data-row">
            <div class="label">勤務先住所:</div>
            <div class="value">${data.project.workLocation}  <button onclick="visitGoogleMap(${data.project.latitude}, ${data.project.longitude})">地図で見る</button>
            </div>
        </div>
        <div class="data-row">
            <div class="label">顧客先会社:</div>
            <div class="value">${data.project.clientCompany}</div>
        </div>
        <div class="data-row">
            <div class="label">顧客先担当者:</div>
            <div class="value">${data.project.contactName}</div>
        </div>
        <div class="data-row">
            <div class="label">担当者連絡先:</div>
            <div class="value">${data.project.contactPhone}</div>
        </div>
        <div class="data-row">
            <div class="label">ステータス:</div>
            <div class="value ${statusClass}">${statusText}</div>
        </div>
        <div class="data-row">
            <div class="label">案件種類:</div>
            <div class="value">${data.project.projectType.projectTypeName}</div>
        </div>
    </div>
    <div class="project-info-right">
        <div class="data-row">
            <div class="label">プロジェクト要件:</div>
            <div class="value modal-projectRequirements">
                ${data.projectRequirements.map(req => `
                <div class="requirement-item">
                    <div class="skill-info">
                      <img class="skill-icon" data-skill-name="${req.skill.skillName.toLowerCase()}" alt="${req.skill.skillName}">
                    <span>${req.skill.skillName}</span>
                    </div>
                    <div class="experience-info">
                    必要経験: ${(req.requiredExperience / 12).toFixed(1)} 年
                    </div>
                     <div class="count-info ${req.fulfilledCount < req.requiredCount ? 'low-fulfillment' : ''}">
                    充足人数: ${req.fulfilledCount} / ${req.requiredCount}
                    </div>
                </div>
                `).join('')}
            </div>
        </div>
        <div class="data-row">
            <div class="label">配属中従業員:</div>
            <div class="value">
                <select id="employeeDropdown">
                    <option value="">사원을 선택하세요</option>
                    ${data.employeesProjects.map((empProj, index) => `
                        <option value="${index}">${empProj.employeeName || 'N/A'}</option>
                    `).join('')}
                </select>
                <button onclick='cancelSelectedAssignment(${data.projectId}, ${JSON.stringify(data.epID)})'>배정 취소</button>
            </div>
        </div>
    </div>
</div>`;

                // 이미지 설정
                const skillIconMap = {
                    'java': '/img/skillicons/java-icon.png',
                    'javascript': '/img/skillicons/javascript-icon.png',
                    'python': '/img/skillicons/python-icon.png',
                    'ruby': '/img/skillicons/ruby-icon.png',
                    'php': '/img/skillicons/php-icon.png',
                    'go': '/img/skillicons/go-icon.png',
                    'c#': '/img/skillicons/c-sharp-icon.png',
                    'html': '/img/skillicons/html-icon.png',
                    'node.js': '/img/skillicons/node-js-icon.png',
                    'css': '/img/skillicons/css-icon.png',
                    'vue.js': '/img/skillicons/vue-js-icon.png',
                    'react': '/img/skillicons/react-icon.png'
                    // 필요에 따라 추가
                };

                document.querySelectorAll('.skill-icon').forEach(imgElement => {
                    const skillName = imgElement.getAttribute('data-skill-name');
                    if (skillIconMap[skillName]) {
                        imgElement.src = skillIconMap[skillName];
                    }
                });

                document.getElementById('update-btn').addEventListener('click', function () {
                    updateProject(projectId);
                })

                document.getElementById('delete-btn').addEventListener('click', function () {
                    deleteProject(projectId);
                })
                openModal();
            })
            .catch(error => {
                console.error('Error fetching project details:', error);
            });
    }

    function visitGoogleMap(latitude, longitude) {
        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${latitude},${longitude}`;
        window.open(googleMapsUrl, '_blank');
    }

    function cancelSelectedAssignment(projectId, epID) {

        const employeeDropdown = document.getElementById('employeeDropdown');
        const selectedIndex = employeeDropdown.value;
        if (selectedIndex === "") {
            alert("사원을 선택하세요.");
            return;
        }
        // console.log('epId 배열:' + epID);
        const employeeId = epID[selectedIndex];
        // console.log('내가 선택한 사원:' + employeeId);
        fetch(`/getProjectRequirements?projectId=${projectId}`)
            .then(response => response.json())
            .then(projectRequirements => {
                // 데이터 타입 확인
                // console.log("Received projectRequirements:", projectRequirements);
                if (Array.isArray(projectRequirements)) {
                    openProjectRequirementModal(projectId, employeeId, projectRequirements);
                } else {
                    console.error("Error: projectRequirements is not an array");
                }
            })
            .catch(error => {
                console.error('Error fetching project requirements:', error);
            });
    }

    function openProjectRequirementModal(projectId, employeeId, projectRequirements) {
        const modalRequirementsList = document.getElementById('modal-requirements-list');
        modalRequirementsList.innerHTML = '';  // 기존 내용을 초기화

        // 프로젝트 요구사항을 모달에 렌더링
        projectRequirements.forEach(req => {
            const requirementElement = document.createElement('div');
            requirementElement.innerHTML = `
            <label>
                <input type="radio" name="projectRequirement" value="${req.id}">
                스킬: ${req.skill.skillName}, 필요 경험: ${req.requiredExperience}개월, 필요 인원: ${req.requiredCount}명
            </label>
        `;
            modalRequirementsList.appendChild(requirementElement);
        });

        const confirmButton = document.createElement('button');
        confirmButton.textContent = '확인';
        confirmButton.onclick = function () {
            confirmCancelAssignment(projectId, employeeId);
        };
        modalRequirementsList.appendChild(confirmButton);

        document.getElementById('project-requirement-modal').style.display = 'block';
    }

    function confirmCancelAssignment(projectId, employeeId) {
        const selectedRequirement = document.querySelector('input[name="projectRequirement"]:checked');
        if (!selectedRequirement) {
            alert('요구사항을 선택하세요.');
            return;
        }

        const projectRequirementsId = selectedRequirement.value;
        if (confirm('정말 배정을 취소하시겠습니까?')) {
            cancelAssignment(projectId, employeeId, projectRequirementsId);
            closeProjectRequirementModal();
        }
    }

    function cancelAssignment(projectId, employeeId, projectRequirementsId) {
        console.log(projectId)
        console.log(employeeId)
        console.log(projectRequirementsId)

        const url = `/matchCancel?projectId=${projectId}&employeeId=${employeeId}&projectRequirementsId=${projectRequirementsId}`;

        fetch(url, {
            method: 'GET'
        })
            .then(response => response.text())
            .then(result => {
                if (result === "취소 성공") {
                    alert("배정이 취소되었습니다.");
                    // 필요하다면 모달을 닫거나 페이지를 새로고침
                    location.reload()
                } else {
                    alert("배정 취소에 실패했습니다.");
                }
            })
            .catch(error => {
                console.error('Error cancelling assignment:', error);
                alert("배정 취소 중 오류가 발생했습니다.");
            });
    }


    function closeProjectRequirementModal() {
        document.getElementById('project-requirement-modal').style.display = 'none';
    }

    function filterByStatus() {
        const selectedStatus = document.getElementById('filterByStatus').value;
        const projects = document.querySelectorAll('.projects > .project');

        projects.forEach(project => {
            const projectStatus = project.querySelector('.status').textContent.trim();

            // 선택된 상태와 프로젝트 상태가 일치하거나, 모든 상태가 선택된 경우
            if (selectedStatus === "" || projectStatus === selectedStatus) {
                project.style.display = '';
            } else {
                project.style.display = 'none';
            }
        });
    }

    function filterByProjectId() {
        const inputId = document.getElementById('filterByProjectId').value.trim();
        const projects = document.querySelectorAll('.projects > .project');

        projects.forEach(project => {
            const projectId = project.querySelector('.project-id').textContent.trim();

            if (projectId === inputId || inputId === "") {
                project.style.display = '';
            } else {
                project.style.display = 'none';
            }
        });
    }

    function filterByProjectName() {
        const filter = document.getElementById('filterByProjectName').value.toLowerCase();
        const projects = document.querySelectorAll('.projects > .project');

        projects.forEach(project => {
            const projectName = project.querySelector('.project-name').textContent.toLowerCase();
            if (projectName.includes(filter)) {
                project.style.display = "";
            } else {
                project.style.display = "none";
            }
        });
    }

    function filterByClientName() {
        const filter = document.getElementById('filterByClientName').value.toLowerCase();
        const projects = document.querySelectorAll('.projects > .project');

        projects.forEach(project => {
            const clientName = project.querySelector('.client-company').textContent.toLowerCase();
            if (clientName.includes(filter)) {
                project.style.display = "";
            } else {
                project.style.display = "none";
            }
        });
    }

    function sortProjectsByDate() {
        const sortBy = document.getElementById('sortProjectsByDate').value;
        const projects = Array.from(document.querySelectorAll('.projects > .project'));
        const projectsContainer = document.querySelector('.projects');

        const currentDate = new Date();
        const sortClass = sortBy === 'startDate' ? 'start-date' : 'end-date';

        const futureProjects = projects.filter(project => {
            const projectDate = new Date(project.querySelector(`.${sortClass}`).textContent);
            return projectDate >= currentDate;
        });

        // 현재 날짜보다 이전의 항목들 (과거)
        const pastProjects = projects.filter(project => {
            const projectDate = new Date(project.querySelector(`.${sortClass}`).textContent);
            return projectDate < currentDate;
        });

        futureProjects.sort((a, b) => {
            const aValue = new Date(a.querySelector(`.${sortClass}`).textContent);
            const bValue = new Date(b.querySelector(`.${sortClass}`).textContent);
            return aValue - bValue;
        });

        // 과거 항목들을 정렬
        pastProjects.sort((a, b) => {
            const aValue = new Date(a.querySelector(`.${sortClass}`).textContent);
            const bValue = new Date(b.querySelector(`.${sortClass}`).textContent);
            return aValue - bValue;
        });

        // 정렬된 순서대로 다시 배치
        futureProjects.concat(pastProjects).forEach(project => {
            projectsContainer.appendChild(project);
        });

        // 그 아래에 과거 프로젝트를 배치
        pastProjects.forEach(project => {
            projectsContainer.appendChild(project);
        });
    }

    function createProject() {
        location.href = "/createProject"
    }

    function updateProject(projectId) {
        location.href = "/updateProject?id=" + projectId;
    }

    function deleteProject(projectId) {
        if (confirm("정말로 삭제하시겠습니까?")) {
            location.href = "/deleteProject?id=" + projectId;
        }
    }

    function readEmployeesByProjectId(projectId) {
        location.href = "/employees?projectId=" + projectId;
    }

    function showCompleteModal(projectId) {
        console.log(projectId)
        const completeModalBody = document.getElementById('complete-modal-body');
        completeModalBody.innerHTML = `<p>プロジェクト ID: ${projectId} を完了処理しますか？</p>
                            <div id="assigned-employees"></div>
                            <div id="assigned-projects"></div>
                            <div id="complete-button-container">
                                <button id="yes-btn">はい</button>
                                <button id="no-btn" onclick="closeCompleteModal()">いいえ</button>
                            </div>`;
        fetch(`/getInfoByProjectID?id=${projectId}`)
            .then(response => response.json())
            .then(data => {
                console.log("Received data:", data);
                const employeesProjects = data.employeesProjects;
                const epID = data.epID;

                console.log(epID);

                const employeesDiv = document.getElementById('assigned-employees');
                //해당 프로젝트 참여 사원에게 해당 안건 점수 부여
                employeesDiv.innerHTML = '<p>프로젝트 참여 사원 점수 부여:</p><ul>' + employeesProjects.map((ep, index) => `
            <li>
                ${epID[index]} ${ep.employeeName} ${ep.projectDuration} ${ep.skill.skillId}, ${ep.skill.skillName}
                <select id="star-point-${index}">
                    ${[...Array(11)].map((_, i) => `<option value="${(i / 2).toFixed(1)}">${(i / 2).toFixed(1)}</option>`).join('')}
                </select>
            </li>`).join('') + '</ul>';


                // "はい" 버튼 클릭 시 completeProject 함수 호출
                document.getElementById('yes-btn').addEventListener('click', function () {
                    const projectParticipantsInfos = employeesProjects.map((ep, index) => {
                        const starPoint = document.getElementById(`star-point-${index}`).value;
                        const result = {
                            employeeId: epID[index],
                            starPoint: parseFloat(starPoint),
                            skillId: ep.skill.skillId,
                            projectDuration: parseFloat(ep.projectDuration)
                        };
                        console.log(result); // 콘솔에 출력
                        return result;
                    });
                    completeProject(projectId, projectParticipantsInfos);
                });
            })
            .catch(error => {
                console.error('Error fetching project info:', error);
            });

        openCompleteModal();
    }

    function completeProject(projectId, projectParticipantsInfos) {
        console.log(projectId, projectParticipantsInfos)
        fetch(`/completeProject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({projectId: projectId, projectParticipantsInfos: projectParticipantsInfos})
        })
            .then(response => response.text())
            .then(text => {
                console.log('Response from server:', text);
                if (text === "Project completed successfully") {
                    closeCompleteModal();  // 함수 호출
                } else {
                    console.error('Unexpected response:', text);
                }
            })
            .catch(error => {
                console.error('Error completing project:', error);
            });
    }

    function navigateToMatchManagement() {
        window.location.href = /*[[@{/matchManagement}]]*/ '/matchManagement';
    }

    function openModal() {
        document.getElementById('modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    function openCompleteModal() {
        document.getElementById('complete-modal').style.display = 'block';
    }

    function closeCompleteModal() {
        document.getElementById('complete-modal').style.display = 'none';
    }

    const imminentStartDays = /*[[${imminentStartDays}]]*/ 0;

    const imminentEndDays = /*[[${imminentEndDays}]]*/ 0;

    function updateProjectDatesStyles() {
        const projects = document.querySelectorAll('.projects > .project');
        const currentDate = new Date();

        projects.forEach(project => {
            const startDateElement = project.querySelector('.start-date');
            const endDateElement = project.querySelector('.end-date');
            const startDate = new Date(startDateElement.textContent.trim());
            const endDate = new Date(endDateElement.textContent.trim());

            // 시작일이나 종료일이 현재 날짜에 임박했을 경우 스타일 추가
            const imminentStart = (startDate - currentDate) / (1000 * 60 * 60 * 24);
            const imminentEnd = (endDate - currentDate) / (1000 * 60 * 60 * 24);

            if (imminentStart <= imminentStartDays && imminentStart >= 0) {
                startDateElement.style.color = 'orange';
                startDateElement.style.fontWeight = 'bold';
            }
            if (imminentEnd <= imminentEndDays && imminentEnd >= 0) {
                endDateElement.style.color = 'red';
                endDateElement.style.fontWeight = 'bold';
            }
        });

    }

    window.onclick = function (event) {
        if (event.target == document.getElementById('modal')) {
            closeModal();
        }
    }
    window.onload = function () {
        updateProjectDatesStyles();
        filterByStatus();
        sortProjectsByDate();
    }




</script>
</body>
</html>